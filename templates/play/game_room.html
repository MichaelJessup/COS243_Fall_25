{% extends "base.html" %}
{% block title %}View Flash Cards{% endblock %}
{% block head %}
	{{ super() }}
{% endblock %}
{% block content %}
	{% if not user_name or user_name is none %}
		<h1 class="title">Please log in:</h1>
		<hr>
		<br>
		<section id="meat">
			<section id="login">
			    <form id="form" method="post">
			        <p>Username: </p> <input id="user_name" type="text" name="user_name" placeholder="Jeffe Jefferson III" required maxlength="16">
					<input type="submit" value="Submit">
			    </form>
			</section>
		</section>
		<br>
		<hr>

		<script>
			window.onload = do_request();
			
			let action = "/game/login";

			function getAction(form) {
				form.action = action;
			}

			function do_request() {
				fetch("/game/inactive").then(response => {
					if (!response.ok) {
						throw new Error(`HTTP error! status: ${response.status}`);
					}
					return response.json();
				}).then(data => {
					console.log(data);
					if (!data) {
						action = "/game/setup";
					}
					getAction(document.getElementById("form"));

					console.log(document.getElementById("form").action);
					return data;
				}).catch(error => {
					console.error("There was a problem with detecting if there is a game yet:", error);
				});
			}
		</script>
	{% else %}
		<h1 id="greet_user" class="title">Hello {{user_name}}</h1>
		<hr>
		<br>
		<section id="meat">
			<section id="card" style="display: none;">
				<div class="card">
					<h2 id="question">front</h2>
					<h3 id="answer" style="display: none;">back</h3>
				</div>
			</section>
			<section class="chat">
			    <ul id="messages"></ul>
			    <form action="/game" onsubmit="sendMessage(event)">
		        	<textarea id="messageText" rows=1
		        	placeholder="type /start to begin and /end to close game session"
		        	onInput="this.parentNode.dataset.replicatedValue = this.value"></textarea>
			        <button>Send!</button>
			    </form>
			</section>
			<section class="display">
				<ul id="scoreboard"></ul>
			</section>
		</section>
		{% for set in sets %}
			<section class="hidden_set" style="display: none">
				<a class="set_link" href="{{ url_for('get_set', set_id=set.id) }}">SET: {{ set.name }}</a>
				<section id="set{{set.id}}" class="hidden_cards">
					{% for card in set.cards %}
						{% if card in cards %}
							<div id="{{card.id}}" class="one" style="grid-row : {{ (loop.index - loop.index/2 | round(0, 'floor')) | int}}">
								<p class="front">{{card.front}}</p>
								<p class="back">{{card.back}}</p>
							</div>
						{% endif %}
					{% endfor %}
				</section>
			</section>
		{% endfor %}
	{% endif %}

	<script>
		let sets = {};
		let cards = new Array();
		let answered = new Array();
		let question = document.getElementById("question");
		let answer = document.getElementById("answer");
		let user_name = "";
		let score = {};

	    function getCookie(name) {
	        const value = `; ${document.cookie}`
	        const parts = value.split(`; ${name}`);
	        if (parts.length ===2) return parts.pop().split(';').shift();
	    }

	    let client_id = getCookie('user_name').slice(1);
	    let ws = new WebSocket(`ws://localhost:8000/ws/${client_id}`)

	    ws.onmessage = function(event) {
			if (event.data.includes("answer")) {
	        	console.log("getting new answer...");

	        	let data = JSON.parse(event.data.replaceAll(/'/g, '"'));
	        	let messages = document.getElementById('messages');
		        let message = document.createElement('li');
		        let content = document.createTextNode(
		        	data.answer + 
		        	" answered the question!"
		        );

		        message.appendChild(content);
		        messages.appendChild(message);

		        message = document.createElement('li');
		    	content = document.createTextNode(
		    		"answer was: " + answer.textContent
		    	);

		    	message.classList.add("answer");
		    	message.appendChild(content);
		    	messages.appendChild(message);

		        if (!event.data.includes("nobody put this in, this is a secret message that ends the game")) {
		        	setCard(data.card);
		    	}
	        }
	        else if (event.data.includes("start")) {
	        	console.log("starting...");
	        	if (answered.length != 0) {
		        	cards.push(...answered);
		        	answered = new Array();
		        }
		        score = {};
	        	setCard(JSON.parse(event.data.replaceAll(/'/g, '"')).start);
	        	question.parentElement.parentElement.style.display = "grid";
	        }
		    else if (event.data.startsWith("whisper to ") || event.data.includes("whispers: ")) {
		    	let messages = document.getElementById('messages');
		        let message = document.createElement('li');
		        let content = document.createTextNode(event.data);

		        message.classList.add("whisper");
		        message.appendChild(content);
		        messages.appendChild(message);
		    }
		    else if (event.data.includes("scores")) {
	        	console.log("updating scores...");
	        	let data = event.data.replaceAll(/'/g, '"');
	        	data = data.replaceAll(/\(/g, '\[');
	        	data = data.replaceAll(/\)/g, '\]');
	        	data = JSON.parse(data);

	        	updateScoreBoard(data["scores"]);
	        }
	        else if (!event.data.includes("nobody put this in, this is a secret message that ends the game")) {
		        let messages = document.getElementById('messages');
		        let message = document.createElement('li');
		        let content = document.createTextNode(event.data);

		        message.appendChild(content);
		        messages.appendChild(message);
		    }
		    else {
	        	console.log("ending...");
	        	question.parentElement.parentElement.style.display = "none";

	        	let maxScore = Math.max(...Object.values(score));
	        	let winner = getKeyByValue(score, maxScore);

	        	let messages = document.getElementById('messages');
		        let message = document.createElement('li');
		        let content = document.createTextNode(
		        	winner + " won with " + maxScore.toString() + " questions answered correctly!"
		        );

		        message.appendChild(content);
		        messages.appendChild(message);
	        }
	    }

	    function getKeyByValue(d, v) {
	    	return Object.keys(d).find(k => d[k] === v);
	    }

	    function sendMessage(event){
	        
	        event.preventDefault();
	        let input = document.getElementById("messageText");
	        if (input.value.replaceAll(/\s/g, "").toLowerCase() == answer.textContent.replaceAll(/\s/g, "").toLowerCase()) {
	        	console.log("answered");
	        	ws.send(JSON.stringify({
	        		payload: {answer:user_name, card:getRandomCard()}
	        	}));

	        	if (cards.length == 0) {
		        	ws.send(JSON.stringify({
		        		payload: {end:"nobody put this in, this is a secret message that ends the game"}
		        	}));
		        }
	        }
	        else if (input.value.slice(0,6) == "/start") {
	        	question.parentElement.parentElement.style.display = "grid";
	        	if (answered.length != 0) {
		        	cards.push(...answered);
		        	answered = new Array();
		        }
	        	let m = JSON.stringify({
	        		payload: {start:getRandomCard()}
	        	});
	        	ws.send(m);
	        }
	        else if (input.value.slice(0,4) == "/end") {
	        	question.parentElement.parentElement.style.display = "none";
	        	ws.send(JSON.stringify({
	        		payload: {end:"nobody put this in, this is a secret message that ends the game"}
	        	}));
	        }
	        else if (input.value.slice(0,2) == "/w") {
	        	console.log("shhhh...")
	        	ws.send(JSON.stringify({
	        		payload: {secret:input.value.slice(3)}
	        	}));
	        }
	        else {
		        ws.send(JSON.stringify({
		            payload: {message:input.value}
		        }));
		    }
	        input.value = '';
	    }

	    function setCard(id) {
	    	const card = document.getElementById(cards[id]);
	    	
	    	question.textContent = card.children[0].textContent;
	    	answer.textContent = card.children[1].textContent;

	    	answered.push(cards[id]);
	    	cards.splice(id, 1);
	    }

	    function getRandomCard() {
	    	if (cards.length == 0) {
	    		return "nobody put this in, this is a secret message that ends the game";
	    	}
	    	return Math.floor(Math.random() * cards.length);
	    }

	    window.onload = setup();

	    function setup() {
	    	const dom_s = document.getElementsByClassName("hidden_set");

	    	for (let s of dom_s) {
	    		const dom_c = s.children[1].children;
	    		const set_id = s.children[1].id;
	    		for (let c of dom_c) {
	    			if (set_id in sets) {
		    			sets[set_id].push(c.id);
		    			cards.push(c.id);
		    		}
		    		else {
		    			sets[set_id] = new Array();
		    			sets[set_id].push(c.id);
		    			cards.push(c.id);
		    		}
	    		}
	    	}

	    	if (document.getElementById("greet_user") != null) {
	    		user_name = document.getElementById("greet_user").textContent.slice(6);
	    	}

	    	let textarea = document.getElementById("messageText");
	    	let style = window.getComputedStyle(textarea);

	    	if (style.padding == "4%") {
	    		textarea.rows = 3;
	    	}
	    }

	    function updateScoreBoard(scores) {
	    	console.log("updating scoreboard...")
	    	for (let s of scores) {
			        score[s[0]] = s[1];
	        	}

	    	let sb = document.getElementById("scoreboard");
	    	sb.replaceChildren();

	    	for (let key in score) {
	    		let l = document.createElement('li');
		        let s = document.createTextNode(
		        	key + ": " + score[key].toString()
		        );

		        l.appendChild(s);
		        sb.appendChild(l);
	    	}
	    }
	</script>
{% endblock %}
